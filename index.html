<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¤¾æœƒæŠ€å·§èª²ï¼šæµ£ç†Šçš„æˆ¿é–“</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f0f4f8;
            margin: 0;
            overflow: hidden; 
        }
        .slide-wrapper {
            width: 100vw;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #e2e8f0;
            padding: 0;
        }
        .slide-container {
            width: 100%;
            height: 100%;
            background: white;
            overflow: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        .content-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-evenly;
            align-items: center;
            padding: 1rem 2rem;
            width: 100%;
            height: 100%;
        }
        .content-scroll-area {
            flex: 1;
            overflow-y: auto; 
            scrollbar-width: none; 
            -ms-overflow-style: none;
            width: 100%;
            padding: 2rem;
        }
        .tablet-mode-container {
            width: 100vw;
            height: 100vh;
            background-color: #fce7f3; 
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 2rem;
        }
        .animate-bounce-slow {
            animation: bounce 2s infinite;
        }
        @keyframes stamp {
            0% { opacity: 0; transform: scale(3); }
            100% { opacity: 1; transform: scale(1); }
        }
        .stamp-animation {
            animation: stamp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        .flip-card { perspective: 1000px; }
        .flip-card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.8s;
            transform-style: preserve-3d;
        }
        .flip-card.flipped .flip-card-inner { transform: rotateY(180deg); }
        .flip-card-front, .flip-card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border-radius: 1.5rem;
        }
        .flip-card-back { transform: rotateY(180deg); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // =========================================================================
        // ã€è€å¸«çš„ Firebase è¨­å®šã€‘
        // =========================================================================
        const TEACHER_FIREBASE_CONFIG = {
            apiKey: "AIzaSyDhwu9YAyfMxZtC5BhGKzmVyxWdQ4qW3MM",
            authDomain: "social-89bcb.firebaseapp.com",
            projectId: "social-89bcb",
            storageBucket: "social-89bcb.firebasestorage.app",
            messagingSenderId: "638955050705",
            appId: "1:638955050705:web:aec1eb12e9142c9a7ad7f0",
            measurementId: "G-CG8V25F05H"
        };
        // =========================================================================

        const getFirebaseConfig = () => {
            if (TEACHER_FIREBASE_CONFIG) return TEACHER_FIREBASE_CONFIG;
            try {
                if (typeof __firebase_config !== 'undefined') return JSON.parse(__firebase_config);
            } catch (e) { console.warn("No preview config found"); }
            return null;
        };

        const firebaseConfig = getFirebaseConfig();
        let db = null;
        let auth = null;
        const COLLECTION_NAME = 'students_session_v2_safe_ids';
        const appId = firebaseConfig ? firebaseConfig.projectId : 'classroom-raccoon-001';
        
        if (firebaseConfig && firebase.apps.length === 0) {
            try {
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                auth = firebase.auth();
                console.log("Firebase initialized.");
            } catch(e) {
                console.error("Firebase init error", e);
            }
        }

        const STUDENT_DATA = [
            { id: 's1', name: 'ç‘€å®‰' },
            { id: 's2', name: 'æ‰¿ç†™' },
            { id: 's3', name: 'æ›¸æ„·' },
            { id: 's4', name: 'å²·ç¿°' },
            { id: 's5', name: 'ç¿ç©' },
            { id: 's6', name: 'å®‡è»’' },
            { id: 's7', name: 'æ¥·å…ƒ' },
            { id: 's8', name: 'å®ˆæ©' }
        ];

        const MOCK_STUDENTS = STUDENT_DATA.map((s, index) => ({
            id: s.id,
            name: s.name,
            order: index,
            checks: { eyes: false, hand: false, mouth: false },
            submitted: false,
            completed: false
        }));

        const App = () => {
            const [currentSlide, setCurrentSlide] = useState(0);
            const [lightStatus, setLightStatus] = useState('red');
            const [user, setUser] = useState(null);
            const [students, setStudents] = useState(MOCK_STUDENTS);
            const [isTabletMode, setIsTabletMode] = useState(false);
            const [selectedStudentId, setSelectedStudentId] = useState(null);
            const [isOfflineMode, setIsOfflineMode] = useState(!db); 
            const [isLocalFile, setIsLocalFile] = useState(false);
            const [loadingError, setLoadingError] = useState("");
            const [connectionStatus, setConnectionStatus] = useState("connecting");
            const [revealResults, setRevealResults] = useState(false);

            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                if (params.get('mode') === 'student') setIsTabletMode(true);
                if (window.location.protocol === 'file:') {
                    setIsLocalFile(true);
                    setIsOfflineMode(true);
                    setConnectionStatus("disconnected");
                }
            }, []);

            useEffect(() => {
                if (!db) {
                    setConnectionStatus("disconnected");
                    const savedData = localStorage.getItem('local_students_data_v2');
                    if (savedData) setStudents(JSON.parse(savedData));
                    return;
                }

                const initAuth = async () => {
                    try {
                        setLoadingError("");
                        setConnectionStatus("connecting");
                        
                        if (TEACHER_FIREBASE_CONFIG) {
                            console.log("Using custom config, forcing anonymous login.");
                            await auth.signInAnonymously();
                        } else if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            try {
                                await auth.signInWithCustomToken(__initial_auth_token);
                            } catch (tokenError) {
                                console.warn("Token failed, falling back to anonymous", tokenError);
                                await auth.signInAnonymously();
                            }
                        } else {
                            await auth.signInAnonymously();
                        }
                    } catch (e) {
                        console.error("Auth error:", e);
                        setConnectionStatus("disconnected");
                        if (e.code === 'auth/operation-not-allowed') {
                            setLoadingError("è«‹å» Firebase Console é–‹å•Ÿã€ŒåŒ¿åç™»å…¥ã€");
                        } else if (e.code === 'auth/unauthorized-domain') {
                            setLoadingError("ç¶²åŸŸæœªæˆæ¬Šï¼šè«‹åˆ° Firebase æ–°å¢ github.io");
                        } else {
                            setLoadingError(`é€£ç·šå¤±æ•—: ${e.code}`);
                        }
                    }
                };
                initAuth();
                const unsubscribe = auth.onAuthStateChanged((u) => {
                    setUser(u);
                    if (u) setConnectionStatus("connected");
                    else setConnectionStatus("disconnected");
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!user || !db) return;

                const studentsRef = db.collection('artifacts').doc(appId)
                                      .collection('public').doc('data')
                                      .collection(COLLECTION_NAME);
                
                const unsubscribe = studentsRef.onSnapshot((snapshot) => {
                    setConnectionStatus("connected");
                    const loadedStudents = [];
                    snapshot.forEach(doc => {
                        loadedStudents.push({ id: doc.id, ...doc.data() });
                    });

                    if (loadedStudents.length > 0) {
                        loadedStudents.sort((a, b) => a.order - b.order);
                        setStudents(loadedStudents);
                        setLoadingError("");
                    } else {
                        initializeStudents(studentsRef);
                    }
                }, (error) => {
                    console.error("Firestore Error:", error);
                    setConnectionStatus("disconnected");
                    setLoadingError("è³‡æ–™åº«æ–·ç·š: " + error.message);
                });

                return () => unsubscribe();
            }, [user]);

            const initializeStudents = async (collectionRef = null) => {
                if (!db) return;
                try {
                    const targetRef = collectionRef || db.collection('artifacts').doc(appId)
                                      .collection('public').doc('data')
                                      .collection(COLLECTION_NAME);
                    
                    const batch = db.batch();
                    STUDENT_DATA.forEach((s, index) => {
                        const docRef = targetRef.doc(s.id);
                        batch.set(docRef, {
                            name: s.name,
                            order: index,
                            checks: { eyes: false, hand: false, mouth: false },
                            submitted: false,
                            completed: false
                        });
                    });
                    await batch.commit();
                    console.log("Initialized V2 data");
                } catch (e) {
                    console.error("Init failed", e);
                }
            };

            const resetAllStudents = async () => {
                if (!db || !user) {
                    alert("æœªé€£ç·šï¼Œç„¡æ³•é‡ç½®");
                    return;
                }
                if (!confirm("ç¢ºå®šè¦é‡ç½®æ‰€æœ‰å­¸ç”Ÿçš„ç‹€æ…‹å—ï¼Ÿ")) return;
                
                setRevealResults(false);

                try {
                    const batch = db.batch();
                    const collectionRef = db.collection('artifacts').doc(appId)
                                          .collection('public').doc('data')
                                          .collection(COLLECTION_NAME);
                    
                    students.forEach(student => {
                        const docRef = collectionRef.doc(student.id);
                        batch.update(docRef, {
                            checks: { eyes: false, hand: false, mouth: false },
                            submitted: false
                        });
                    });
                    await batch.commit();
                } catch (e) {
                    console.error("Reset failed", e);
                    alert("é‡ç½®å¤±æ•—: " + e.message);
                }
            };

            const updateStudentCheck = async (studentId, checkItem, currentValue) => {
                const nextValue = !currentValue;
                setStudents(prev => prev.map(s => {
                    if (s.id === studentId) {
                        return { ...s, checks: { ...s.checks, [checkItem]: nextValue } };
                    }
                    return s;
                }));

                if (db && user) {
                    try {
                        const studentRef = db.collection('artifacts').doc(appId)
                                             .collection('public').doc('data')
                                             .collection(COLLECTION_NAME)
                                             .doc(studentId);
                        studentRef.update({ [`checks.${checkItem}`]: nextValue });
                    } catch (e) { console.error("Sync failed", e); }
                } else {
                    saveToLocal();
                }
            };

            const submitStudentData = async (studentId, status) => {
                if (!db || !user || connectionStatus !== "connected") {
                    alert("å°šæœªé€£ç·šåˆ°é›²ç«¯ï¼Œç„¡æ³•é€å‡ºåˆ°é›»è¦–ï¼è«‹æª¢æŸ¥å³ä¸Šè§’ç‡ˆè™Ÿã€‚");
                    return;
                }

                // 1. é¦¬ä¸Šæ›´æ–°ç•«é¢ (è®“å­¸ç”Ÿè¦ºå¾—ç§’å‚³)
                setStudents(prev => prev.map(s => {
                    if (s.id === studentId) return { ...s, submitted: status };
                    return s;
                }));

                // 2. èƒŒæ™¯å‚³é€è³‡æ–™ (ä¸ä½¿ç”¨ await é˜»æ“‹)
                try {
                    const studentRef = db.collection('artifacts').doc(appId)
                                         .collection('public').doc('data')
                                         .collection(COLLECTION_NAME)
                                         .doc(studentId);
                    studentRef.update({ submitted: status });
                } catch (e) {
                    console.error("Sync failed", e);
                    // åªæœ‰çœŸçš„å¤±æ•—æ™‚æ‰åœ¨ console å ±éŒ¯ï¼Œä¸å½±éŸ¿ä½¿ç”¨è€…ç•¶ä¸‹æ“ä½œ
                }
            };

            const saveToLocal = () => {
                localStorage.setItem('local_students_data_v2', JSON.stringify(students));
            };

            const calculateScore = (checks) => Object.values(checks || {}).filter(Boolean).length;

            const totalSlides = 9;
            const nextSlide = () => { if (currentSlide < totalSlides - 1) setCurrentSlide(currentSlide + 1); };
            const prevSlide = () => { if (currentSlide > 0) setCurrentSlide(currentSlide - 1); };

            useEffect(() => {
                const handleKeyDown = (e) => {
                    if (isTabletMode) return;
                    if (e.key === 'ArrowRight' || e.key === ' ') nextSlide();
                    if (e.key === 'ArrowLeft') prevSlide();
                };
                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, [currentSlide, isTabletMode]);

            // --- Status Component ---
            const ConnectionStatus = () => {
                let color = "bg-gray-400";
                let text = "é€£ç·šä¸­...";
                if (connectionStatus === "connected") { color = "bg-green-500"; text = "â— é€£ç·šæ­£å¸¸"; }
                else if (connectionStatus === "disconnected") { color = "bg-red-500"; text = "â— æ–·ç·š"; }
                else if (connectionStatus === "connecting") { color = "bg-yellow-500"; text = "â— é€£ç·šä¸­..."; }

                return (
                    <div className="absolute top-4 right-4 flex items-center gap-3 z-50 bg-white/90 px-4 py-2 rounded-full shadow-md border-2 border-gray-100">
                        <span className={`text-lg font-bold ${color === 'bg-green-500' ? 'text-green-600' : 'text-red-500'}`}>{text}</span>
                    </div>
                );
            };

            // --- Views ---
            if (isTabletMode) {
                if (selectedStudentId === null) {
                    return (
                        <div className="tablet-mode-container p-8">
                            <ConnectionStatus />
                            {loadingError && <div className="mt-12 text-center bg-red-100 p-4 text-red-600 font-bold rounded-xl border-2 border-red-300">{loadingError}</div>}
                            
                            <h1 className="text-6xl font-black text-pink-800 text-center mb-10 mt-12">æˆ‘æ˜¯èª°ï¼Ÿ</h1>
                            
                            <div className="grid grid-cols-2 gap-8 max-w-6xl mx-auto">
                                {students.map(student => (
                                    <button
                                        key={student.id}
                                        onClick={() => {
                                            if(connectionStatus !== 'connected') alert("è«‹ç­‰å¾…é€£ç·šæˆåŠŸ...");
                                            else setSelectedStudentId(student.id);
                                        }}
                                        className={`p-10 rounded-[2.5rem] shadow-xl border-b-[12px] active:translate-y-2 active:border-b-0 transition-all ${student.submitted ? 'bg-green-100 border-green-400' : 'bg-white border-pink-300'}`}
                                    >
                                        <div className="text-5xl font-bold text-gray-800">{student.name}</div>
                                        {student.submitted && <div className="mt-4 text-3xl font-bold text-green-700">å·²é€å‡º âœ…</div>}
                                    </button>
                                ))}
                            </div>
                        </div>
                    );
                } else {
                    const currentStudent = students.find(s => s.id === selectedStudentId);
                    if (!currentStudent) return <div>è¼‰å…¥ä¸­...</div>;
                    const isSubmitted = currentStudent.submitted;

                    return (
                        <div className="tablet-mode-container flex flex-col items-center">
                            <ConnectionStatus />
                            <div className="w-full max-w-4xl flex justify-between items-center mb-10 mt-12">
                                <h2 className="text-6xl font-black text-pink-800">{currentStudent.name}</h2>
                                <button onClick={() => setSelectedStudentId(null)} className="bg-gray-200 text-gray-700 px-10 py-4 rounded-full font-bold text-3xl shadow-md">è¿”å›</button>
                            </div>
                            
                            <div className="flex-1 w-full max-w-4xl space-y-8 relative">
                                {isSubmitted && (
                                    <div className="absolute inset-0 bg-white/90 z-10 rounded-[3rem] flex flex-col items-center justify-center backdrop-blur-sm border-8 border-green-200">
                                        <div className="text-9xl mb-6">âœ…</div>
                                        <div className="text-7xl font-bold text-green-700 mb-12">ç­”æ¡ˆå·²é€å‡ºï¼</div>
                                        <button 
                                            onClick={() => submitStudentData(currentStudent.id, false)}
                                            className="bg-gray-500 text-white px-12 py-6 rounded-full font-bold text-4xl shadow-lg hover:bg-gray-600"
                                        >
                                            ä¿®æ”¹ç­”æ¡ˆ
                                        </button>
                                    </div>
                                )}

                                {[{ key: 'eyes', icon: 'ğŸ‘€', text: 'æˆ‘æœ‰çœ‹ç´…ç¶ ç‡ˆ' }, { key: 'hand', icon: 'âœ‹', text: 'æˆ‘æƒ³èªªè©±æœ‰èˆ‰æ‰‹' }, { key: 'mouth', icon: 'ğŸ¤', text: 'åˆ¥äººèªªè©±æˆ‘å®‰éœ' }].map(item => (
                                    <div key={item.key} onClick={() => !isSubmitted && updateStudentCheck(currentStudent.id, item.key, currentStudent.checks[item.key])} className={`flex items-center p-10 bg-white rounded-[2.5rem] shadow-lg cursor-pointer transition-all border-l-[30px] active:scale-95 ${currentStudent.checks[item.key] ? 'border-green-500 bg-green-50' : 'border-gray-300'}`}>
                                        <div className={`w-28 h-28 rounded-3xl border-[8px] mr-10 flex items-center justify-center transition-colors flex-shrink-0 ${currentStudent.checks[item.key] ? 'bg-green-500 border-green-500' : 'border-gray-300'}`}>{currentStudent.checks[item.key] && <span className="text-7xl text-white font-bold">âœ“</span>}</div>
                                        <span className="text-8xl mr-10">{item.icon}</span><span className="text-5xl font-bold text-gray-700">{item.text}</span>
                                    </div>
                                ))}
                            </div>
                            
                            {!isSubmitted && (
                                <div className="mt-12 mb-12 w-full max-w-4xl">
                                    <button 
                                        onClick={() => submitStudentData(currentStudent.id, true)}
                                        className="w-full bg-pink-500 hover:bg-pink-600 text-white text-6xl font-black py-10 rounded-[3rem] shadow-2xl border-b-[16px] active:translate-y-2 active:border-b-0 transition-all flex items-center justify-center gap-6"
                                    >
                                        <span>ğŸš€</span> ç¢ºèªé€å‡º
                                    </button>
                                </div>
                            )}
                        </div>
                    );
                }
            }

            const SlideContent = () => {
                switch(currentSlide) {
                    case 0: return (
                        <div className="content-area bg-blue-50">
                            <div className="text-[15rem] animate-bounce-slow mt-4">ğŸ¦</div>
                            <h1 className="text-9xl font-black text-blue-800 tracking-wider mb-12">ç¤¾æœƒæŠ€å·§èª²</h1>
                            <div className="bg-white px-16 py-8 rounded-[3rem] border-[10px] border-blue-300 shadow-2xl mb-8"><h2 className="text-6xl font-bold text-gray-700">æµ£ç†Šçš„æˆ¿é–“èˆ‡èªªè©±è¦å‰‡</h2></div>
                            <p className="text-4xl text-gray-500 font-bold">æº–å‚™å¥½ä½ çš„è€³æœµå’Œçœ¼ç›äº†å—ï¼Ÿ</p>
                        </div>
                    );
                    case 1: return (
                        <div className="content-area bg-yellow-50 px-8">
                            <h2 className="text-7xl font-bold text-yellow-800 mb-16 border-b-[12px] border-yellow-200 pb-6">ä»Šå¤©çš„ä»»å‹™</h2>
                            <div className="flex-1 flex flex-col justify-center gap-12 w-full max-w-6xl">
                                <div className="flex items-center p-10 bg-white rounded-[3rem] shadow-xl border-l-[30px] border-blue-500 hover:scale-105 transition-transform"><span className="text-8xl mr-12">ğŸ“–</span><span className="text-6xl font-bold text-gray-700">1. è½ç¹ªæœ¬æ•…äº‹</span></div>
                                <div className="flex items-center p-10 bg-white rounded-[3rem] shadow-xl border-l-[30px] border-green-500 hover:scale-105 transition-transform"><span className="text-8xl mr-12">ğŸ²</span><span className="text-6xl font-bold text-gray-700">2. ç©ã€Œèªªè©±éŠæˆ²ã€</span></div>
                                <div className="flex items-center p-10 bg-white rounded-[3rem] shadow-xl border-l-[30px] border-red-500 hover:scale-105 transition-transform"><span className="text-8xl mr-12">â­</span><span className="text-6xl font-bold text-gray-700">3. é ˜å–çå‹µè²¼ç´™</span></div>
                            </div>
                        </div>
                    );
                    case 2: return (
                        <div className="content-area bg-white px-8">
                            <h2 className="text-7xl font-bold text-center text-gray-800 mb-16">æ•™å®¤è£¡çš„ç´…ç¶ ç‡ˆ</h2>
                            <div className="flex justify-center items-center gap-32 flex-1 w-full">
                                <div className={`flex flex-col items-center p-16 rounded-[5rem] transition-all duration-300 cursor-pointer ${lightStatus === 'red' ? 'bg-red-50 scale-110 border-[12px] border-red-400 shadow-2xl' : 'opacity-40 grayscale hover:opacity-70'}`} onClick={() => setLightStatus('red')}>
                                    <div className="w-72 h-72 rounded-full bg-red-500 shadow-2xl flex items-center justify-center mb-10 border-[12px] border-white ring-[10px] ring-red-200"><span className="text-[8rem]">ğŸ‘‚</span></div>
                                    <h3 className="text-7xl font-black text-red-600 mb-6">ç´…ç‡ˆ</h3><p className="text-5xl font-bold text-gray-600 mb-4">è€³æœµæ‰“é–‹</p><p className="text-5xl font-bold text-gray-600">å˜´å·´æ‹‰æ‹‰éŠ</p>
                                </div>
                                <div className={`flex flex-col items-center p-16 rounded-[5rem] transition-all duration-300 cursor-pointer ${lightStatus === 'green' ? 'bg-green-50 scale-110 border-[12px] border-green-400 shadow-2xl' : 'opacity-40 grayscale hover:opacity-70'}`} onClick={() => setLightStatus('green')}>
                                    <div className="w-72 h-72 rounded-full bg-green-500 shadow-2xl flex items-center justify-center mb-10 border-[12px] border-white ring-[10px] ring-green-200"><span className="text-[8rem]">ğŸ—£ï¸</span></div>
                                    <h3 className="text-7xl font-black text-green-600 mb-6">ç¶ ç‡ˆ</h3><p className="text-5xl font-bold text-gray-600 mb-4">ç¾åœ¨è¼ªåˆ°ä½ </p><p className="text-5xl font-bold text-gray-600">å¯ä»¥èªªè©±</p>
                                </div>
                            </div>
                        </div>
                    );
                    case 3: return (
                        <div className="content-area bg-indigo-50 px-8">
                            <h2 className="text-7xl font-bold text-indigo-900 mb-16">ç¾åœ¨æ˜¯ä»€éº¼ç‡ˆï¼Ÿ</h2>
                            <div className="flex items-center justify-center gap-32 w-full flex-1">
                                <div className="bg-white p-12 rounded-[4rem] shadow-2xl border-[12px] border-indigo-200 transform -rotate-2">
                                    <div className="relative">
                                        <img src="./room.png" alt="æµ£ç†Šçš„æˆ¿é–“" className="w-[30rem] h-[36rem] object-cover rounded-3xl mb-8 shadow-inner bg-gray-100" onError={(e) => { e.target.style.display = 'none'; e.target.nextSibling.style.display = 'flex'; }} />
                                        <div className="w-[30rem] h-[36rem] bg-gray-200 hidden flex-col items-center justify-center rounded-3xl mb-8 text-gray-400 text-center p-8"><div className="text-center"><div className="text-8xl mb-6">ğŸ“š</div><div className="text-4xl font-bold">åœ–ç‰‡è®€å–å¤±æ•—<br/>room.png</div></div></div>
                                    </div>
                                    <p className="text-5xl text-center font-bold text-gray-700">è€å¸«åœ¨è¬›æ•…äº‹</p>
                                </div>
                                <div className="text-9xl font-bold text-indigo-300 animate-pulse">â¡ï¸</div>
                                <div className="flex flex-col items-center animate-bounce-slow">
                                    <div className="w-72 h-72 rounded-full bg-red-500 shadow-2xl flex items-center justify-center border-[16px] border-white ring-[12px] ring-red-200"><span className="text-[8rem]">ğŸ¤«</span></div>
                                    <p className="text-6xl font-bold text-red-600 mt-12 bg-white px-16 py-6 rounded-full shadow-xl border-8 border-red-100">ç¾åœ¨æ˜¯ç´…ç‡ˆ</p>
                                </div>
                            </div>
                        </div>
                    );
                    case 4: return (
                        <div className="content-area bg-orange-50 px-8">
                            <h2 className="text-7xl font-bold text-orange-800 mb-12 text-center">æˆ‘å¥½æƒ³èªªè©±ï¼Œæ€éº¼è¾¦ï¼Ÿ</h2>
                            <div className="flex-1 flex flex-col justify-center items-center gap-12 w-full">
                                <div className="bg-white px-24 py-12 rounded-[4rem] shadow-2xl border-[10px] border-orange-300 flex flex-col items-center cursor-pointer hover:scale-105 transition-transform">
                                    <span className="text-[12rem] mb-4 leading-none">âœ‹</span><h3 className="text-6xl font-black text-orange-600">ç­‰å¾…å¡</h3>
                                </div>
                                <div className="w-full max-w-5xl space-y-8">
                                    <div className="flex items-center text-5xl font-bold text-gray-700 bg-white/60 p-8 rounded-[2rem]"><span className="bg-orange-500 text-white w-16 h-16 text-4xl rounded-full flex items-center justify-center mr-8 shadow-md font-black flex-shrink-0">1</span>æŠŠã€Œç­‰å¾…å¡ã€èˆ‰é«˜é«˜</div>
                                    <div className="flex items-center text-5xl font-bold text-gray-700 bg-white/60 p-8 rounded-[2rem]"><span className="bg-orange-500 text-white w-16 h-16 text-4xl rounded-full flex items-center justify-center mr-8 shadow-md font-black flex-shrink-0">2</span>å˜´å·´é–‰é–‰ï¼Œçœ¼ç›çœ‹è€å¸«</div>
                                    <div className="flex items-center text-5xl font-bold text-gray-700 bg-white/60 p-8 rounded-[2rem]"><span className="bg-orange-500 text-white w-16 h-16 text-4xl rounded-full flex items-center justify-center mr-8 shadow-md font-black flex-shrink-0">3</span>è€å¸«é»é ­ï¼Œè®Šç¶ ç‡ˆå†èªªè©±</div>
                                </div>
                            </div>
                        </div>
                    );
                    case 5: return (
                        <div className="content-area bg-white px-8">
                            <h2 className="text-6xl font-bold text-center text-purple-800 mb-16">å¹«å¹«å°å…”å­ï¼</h2>
                            <div className="flex-1 flex items-center justify-center space-x-32 w-full">
                                <div className="relative group">
                                    <span className="text-[14rem] block transform group-hover:-translate-y-4 transition-transform duration-300">ğŸ°</span>
                                    <div className="absolute -top-24 -right-32 bg-white border-[10px] border-gray-800 rounded-[3rem] p-8 shadow-2xl w-[28rem] z-10 bubble-bottom-left"><p className="text-4xl font-bold leading-relaxed">æˆ‘å‘Šè¨´ä½ å–”ï¼é‚£å€‹æµ£ç†Šå¾Œä¾†å°±...</p></div>
                                    <p className="text-center text-4xl font-bold mt-6 bg-purple-100 py-4 px-10 rounded-full text-purple-800">é˜¿ç™½ (ä¸€ç›´èªª)</p>
                                </div>
                                <div className="relative opacity-60">
                                    <span className="text-[14rem] block transform scale-x-[-1]">ğŸ°</span>
                                    <div className="absolute -top-12 -left-20 animate-pulse"><span className="text-[8rem]">ğŸ˜–</span></div>
                                    <p className="text-center text-4xl font-bold mt-6 bg-gray-200 py-4 px-10 rounded-full text-gray-600">åœŸåœŸ (æƒ³å®‰éœ)</p>
                                </div>
                            </div>
                            <div className="bg-purple-100 p-10 rounded-[3rem] text-center mt-12 max-w-5xl mx-auto border-[10px] border-purple-200 mb-8">
                                <p className="text-5xl font-bold text-purple-900 mb-4">é˜¿ç™½å¿˜è¨˜çœ‹ç´…ç¶ ç‡ˆäº†ï¼</p><p className="text-4xl text-purple-700 font-bold">èª°å¯ä»¥æ‹¿ã€Œç­‰å¾…å¡ã€æ•™æ•™ä»–ï¼Ÿ</p>
                            </div>
                        </div>
                    );
                    case 6: return (
                        <div className="content-area bg-cyan-50 px-8">
                            <h2 className="text-7xl font-bold text-cyan-800 mb-16">é€™æ˜¯èª°çš„ç™¼è¨€æ™‚é–“ï¼Ÿ</h2>
                            <div className="flex-1 flex flex-col justify-center items-center w-full">
                                <div className="bg-gradient-to-br from-gray-700 to-gray-900 p-12 rounded-full shadow-2xl mb-12 border-[16px] border-gray-300 transform hover:scale-110 transition-transform duration-500"><span className="text-[10rem] text-white">ğŸ¤</span></div>
                                <div className="bg-white p-12 rounded-[3rem] shadow-xl border-l-[30px] border-cyan-500 max-w-6xl w-full">
                                    <div className="grid grid-cols-2 gap-12 text-center">
                                        <div className="p-8 bg-green-50 rounded-[2rem]"><p className="text-4xl text-gray-500 mb-4">æœ‰æ‹¿ <span className="text-cyan-600 font-bold">éº¥å…‹é¢¨</span></p><p className="text-6xl font-black text-green-600">= ç¶ ç‡ˆ ğŸŸ¢</p></div>
                                        <div className="p-8 bg-red-50 rounded-[2rem]"><p className="text-4xl text-gray-500 mb-4">æ²’æœ‰æ‹¿çš„äºº</p><p className="text-6xl font-black text-red-600">= ç´…ç‡ˆ ğŸ”´</p></div>
                                    </div>
                                </div>
                                <p className="mt-16 text-5xl text-gray-600 font-bold bg-white/80 px-16 py-6 rounded-full border-[6px] border-cyan-200 shadow-lg">å¦‚æœä½ æƒ³æ‹¿éº¥å…‹é¢¨ï¼Œè¦å…ˆåšä»€éº¼ï¼Ÿ</p>
                            </div>
                        </div>
                    );
                    case 7: 
                        const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(window.location.href + '?mode=student')}`;
                        return (
                            <div className="content-area bg-pink-50 relative px-8 py-4">
                                <div className="absolute top-4 left-4 flex gap-4">
                                    <ConnectionStatus />
                                    {/* æ‰‹å‹•åŒæ­¥æŒ‰éˆ• */}
                                    <button 
                                        onClick={() => window.location.reload()} 
                                        className="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-full shadow-lg font-bold text-lg flex items-center gap-2"
                                    >
                                        <span>ğŸ”„</span> é‡æ–°æ•´ç†
                                    </button>
                                </div>
                                
                                <div className="flex justify-center items-center mb-8 relative w-full">
                                    <h2 className="text-6xl font-bold text-pink-800 text-center">å…¨ç­æŒ‘æˆ°è³½</h2>
                                    {/* æ­æ›‰æˆç¸¾æŒ‰éˆ• */}
                                    <button 
                                        onClick={() => setRevealResults(!revealResults)} 
                                        className={`absolute right-40 top-0 px-8 py-3 rounded-2xl text-3xl font-bold shadow-lg transition-all transform hover:scale-105 border-4 ${revealResults ? 'bg-gray-500 border-gray-600 text-white' : 'bg-yellow-400 border-yellow-200 text-yellow-900 animate-pulse'}`}
                                    >
                                        {revealResults ? 'ğŸ™ˆ éš±è—æˆç¸¾' : 'ğŸ‘€ æ­æ›‰æˆç¸¾'}
                                    </button>
                                    <button onClick={resetAllStudents} className="absolute right-0 top-0 bg-gray-200 text-gray-600 hover:bg-red-100 hover:text-red-500 px-6 py-3 rounded-xl text-xl font-bold shadow-md">é‡ç½®</button>
                                </div>

                                {isOfflineMode && <div className="absolute top-4 left-4 text-red-500 text-xl font-bold bg-white p-3 rounded-xl shadow-lg border-2 border-red-200 z-50">âš ï¸ æœªè¨­å®š Firebase</div>}
                                {loadingError && (
                                    <div className="absolute top-20 left-6 flex gap-2 z-50">
                                        <div className="text-red-600 font-bold bg-white p-3 rounded-xl border-2 border-red-300 shadow-xl text-lg whitespace-pre-wrap max-w-md">{loadingError}</div>
                                    </div>
                                )}
                                
                                {students.length === 0 && !loadingError && (
                                    <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-center">
                                        <p className="text-gray-500 text-2xl font-bold mb-6">è³‡æ–™åº«ç›®å‰æ˜¯ç©ºçš„</p>
                                        <button onClick={() => initializeStudents()} className="bg-pink-500 text-white px-8 py-4 rounded-full shadow-xl font-bold text-2xl hover:bg-pink-600 transition-colors">
                                            é»æˆ‘åˆå§‹åŒ–å­¸ç”Ÿåå–®
                                        </button>
                                    </div>
                                )}

                                <div className="flex-1 w-full grid grid-cols-4 gap-8 align-content-start overflow-y-auto pb-32 px-4">
                                    {students.map(student => {
                                        const score = calculateScore(student.checks);
                                        const isDone = score === 3;
                                        return (
                                            <div key={student.id} className="flip-card h-72">
                                                <div className={`flip-card-inner ${revealResults && student.submitted ? 'flipped' : ''}`}>
                                                    {/* æ­£é¢ï¼šæœªæ­æ›‰ç‹€æ…‹ (å·²é€å‡ºé¡¯ç¤ºç¶ å‹¾ï¼Œæœªé€å‡ºé¡¯ç¤ºæ€è€ƒ) */}
                                                    <div className={`flip-card-front p-6 shadow-lg border-b-[12px] ${student.submitted ? 'bg-green-100 border-green-400' : 'bg-white border-pink-200'}`}>
                                                        {!student.submitted ? (
                                                            <>
                                                                <div className="text-7xl mb-4 animate-pulse grayscale opacity-50">ğŸ¤”</div>
                                                                <h3 className="text-4xl font-bold text-gray-500 mb-2">{student.name}</h3>
                                                                <div className="text-3xl font-bold text-gray-400">ä½œç­”ä¸­...</div>
                                                            </>
                                                        ) : (
                                                            <>
                                                                <div className="text-8xl mb-4 text-green-500">âœ…</div>
                                                                <h3 className="text-4xl font-bold text-gray-800 mb-2">{student.name}</h3>
                                                                <div className="text-3xl font-bold text-green-700">å·²é€å‡ºï¼</div>
                                                            </>
                                                        )}
                                                    </div>

                                                    {/* èƒŒé¢ï¼šæ­æ›‰æˆç¸¾ç‹€æ…‹ */}
                                                    <div className={`flip-card-back p-6 shadow-lg border-b-[12px] ${isDone ? 'bg-yellow-100 border-yellow-400' : 'bg-white border-pink-200'}`}>
                                                        <div className="text-7xl mb-2">{isDone ? 'ğŸ†' : 'ğŸ‘'}</div>
                                                        <h3 className="text-4xl font-bold text-gray-800 mb-2">{student.name}</h3>
                                                        <div className={`text-5xl font-black mb-4 ${isDone ? 'text-yellow-600' : 'text-pink-600'}`}>
                                                            é”æˆ {score} é …
                                                        </div>
                                                        <div className="w-full bg-gray-200 rounded-full h-5 dark:bg-gray-200 px-1">
                                                            <div className={`h-5 rounded-full transition-all duration-500 ${isDone ? 'bg-yellow-500' : 'bg-pink-500'}`} style={{width: `${(score/3)*100}%`}}></div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>

                                {isLocalFile ? (
                                    <div className="absolute bottom-4 right-4 bg-white p-4 rounded-2xl shadow-xl border-4 border-red-200 flex flex-col items-center max-w-sm">
                                        <p className="font-bold text-red-600 text-xl mb-1">âš ï¸ ç„¡æ³•æƒæ</p>
                                        <p className="text-lg text-gray-600 text-center">æœ¬æ©Ÿæª”æ¡ˆ (file://) ç„¡æ³•é€£ç·š<br/>è«‹ä¸Šå‚³è‡³ç¶²è·¯</p>
                                    </div>
                                ) : (
                                    <div className="absolute bottom-4 right-4 bg-white p-6 rounded-[2rem] shadow-2xl flex items-center gap-8 border-[6px] border-pink-200">
                                        <img src={qrCodeUrl} alt="Scan" className="w-40 h-40" />
                                        <div className="text-left"><p className="font-bold text-gray-700 text-4xl">æƒæåŠ å…¥</p><p className="text-2xl text-gray-500">å¹³æ¿æ¨¡å¼</p></div>
                                    </div>
                                )}
                            </div>
                        );
                    case 8: return (
                        <div className="content-area bg-yellow-100">
                            <div className="text-[15rem] animate-pulse drop-shadow-2xl">ğŸŒŸ</div>
                            <h2 className="text-9xl font-black text-yellow-600 tracking-wider mb-12">ä»»å‹™æˆåŠŸï¼</h2>
                            <p className="text-5xl font-bold text-gray-700 bg-white/60 px-16 py-6 rounded-full mb-12">ä½ å¯ä»¥å»é ˜çå‹µè²¼ç´™å›‰ï¼</p>
                            <div className="flex gap-12 mt-4">
                                <span className="text-9xl animate-bounce" style={{animationDelay: '0s'}}>ğŸ¦</span>
                                <span className="text-9xl animate-bounce" style={{animationDelay: '0.2s'}}>ğŸ°</span>
                                <span className="text-9xl animate-bounce" style={{animationDelay: '0.4s'}}>ğŸ¦Š</span>
                            </div>
                        </div>
                    );
                    default: return <div>Slide Error</div>;
                }
            };

            return (
                <div className="slide-wrapper">
                    <div className="slide-container">
                        <SlideContent />
                        {!isTabletMode && (
                            <>
                                <button onClick={prevSlide} disabled={currentSlide === 0} className="absolute left-6 top-1/2 transform -translate-y-1/2 bg-white/50 hover:bg-white text-gray-800 p-6 rounded-full shadow-lg disabled:opacity-0 transition-all backdrop-blur-sm z-10"><svg xmlns="http://www.w3.org/2000/svg" className="h-12 w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M15 19l-7-7 7-7" /></svg></button>
                                <button onClick={nextSlide} disabled={currentSlide === totalSlides - 1} className="absolute right-6 top-1/2 transform -translate-y-1/2 bg-white/50 hover:bg-white text-gray-800 p-6 rounded-full shadow-lg disabled:opacity-0 transition-all backdrop-blur-sm z-10"><svg xmlns="http://www.w3.org/2000/svg" className="h-12 w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M9 5l7 7-7 7" /></svg></button>
                                <div className="absolute bottom-6 right-8 bg-black/10 px-8 py-2 rounded-full text-gray-600 font-bold text-3xl backdrop-blur-sm">{currentSlide + 1} / {totalSlides}</div>
                            </>
                        )}
                        {!isTabletMode && currentSlide === 7 && isLocalFile && (
                            <button onClick={() => window.open(window.location.href + '?mode=student', '_blank')} className="absolute bottom-4 left-4 bg-pink-600 text-white font-bold p-3 rounded-xl shadow-lg hover:bg-pink-700 z-50 text-xl">é–‹å•Ÿå­¸ç”Ÿå¹³æ¿è¦–çª— (æ¸¬è©¦ç”¨)</button>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
