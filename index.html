<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¤¾æœƒæŠ€å·§èª²ï¼šæµ£ç†Šçš„æˆ¿é–“</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f0f4f8;
            margin: 0;
            overflow: hidden; 
        }
        .slide-wrapper {
            width: 100vw;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #e2e8f0;
            padding: 0;
        }
        .slide-container {
            width: 100%;
            height: 100%;
            background: white;
            overflow: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        /* èª¿æ•´ç‰ˆé¢ï¼šç¸®å° paddingï¼Œè®“å…§å®¹æ›´é›†ä¸­ä¸çˆ†æ¡† */
        .content-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 1rem;
            width: 100%;
            height: 100%;
            box-sizing: border-box;
        }
        .tablet-mode-container {
            width: 100vw;
            height: 100vh;
            background-color: #fce7f3; 
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 1rem;
        }
        .animate-bounce-slow {
            animation: bounce 2s infinite;
        }
        
        @keyframes stamp {
            0% { opacity: 0; transform: scale(3); }
            100% { opacity: 1; transform: scale(1); }
        }
        .stamp-animation {
            animation: stamp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        
        /* ç¿»ç‰Œç‰¹æ•ˆ */
        .flip-card { perspective: 1000px; }
        .flip-card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.8s;
            transform-style: preserve-3d;
        }
        .flip-card-inner.flipped { transform: rotateY(180deg); }
        
        .flip-card-front, .flip-card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border-radius: 1rem;
        }
        .flip-card-back { transform: rotateY(180deg); }

        /* ç¹ªæœ¬é–±è®€å™¨ */
        .book-reader-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.95);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .book-image {
            max-height: 85vh;
            max-width: 90vw;
            box-shadow: 0 0 20px rgba(255,255,255,0.2);
            border-radius: 4px;
            object-fit: contain;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // =========================================================================
        // ã€è€å¸«çš„ Firebase è¨­å®šã€‘
        // =========================================================================
        const TEACHER_FIREBASE_CONFIG = {
            apiKey: "AIzaSyDhwu9YAyfMxZtC5BhGKzmVyxWdQ4qW3MM",
            authDomain: "social-89bcb.firebaseapp.com",
            projectId: "social-89bcb",
            storageBucket: "social-89bcb.firebasestorage.app",
            messagingSenderId: "638955050705",
            appId: "1:638955050705:web:aec1eb12e9142c9a7ad7f0",
            measurementId: "G-CG8V25F05H"
        };

        const getFirebaseConfig = () => {
            if (TEACHER_FIREBASE_CONFIG) return TEACHER_FIREBASE_CONFIG;
            try {
                if (typeof __firebase_config !== 'undefined') return JSON.parse(__firebase_config);
            } catch (e) { console.warn("No preview config found"); }
            return null;
        };

        const firebaseConfig = getFirebaseConfig();
        let db = null;
        let auth = null;
        const COLLECTION_NAME = 'students_session_v3_sync_fix';
        const APP_ID_FIXED = 'social-89bcb'; 

        if (firebaseConfig && firebase.apps.length === 0) {
            try {
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                auth = firebase.auth();
                console.log("Firebase initialized.");
            } catch(e) {
                console.error("Firebase init error", e);
            }
        }

        const STUDENT_DATA = [
            { id: 's1', name: 'ç‘€å®‰' },
            { id: 's2', name: 'æ‰¿ç†™' },
            { id: 's3', name: 'æ›¸æ„·' },
            { id: 's4', name: 'å²·ç¿°' },
            { id: 's5', name: 'ç¿ç©' },
            { id: 's6', name: 'å®‡è»’' },
            { id: 's7', name: 'æ¥·å…ƒ' },
            { id: 's8', name: 'å®ˆæ©' }
        ];

        const MOCK_STUDENTS = STUDENT_DATA.map((s, index) => ({
            id: s.id,
            name: s.name,
            order: index,
            checks: { eyes: false, hand: false, mouth: false },
            submitted: false,
            completed: false
        }));

        // --- æ™‚é˜çµ„ä»¶ ---
        const Clock = () => {
            const [time, setTime] = useState(new Date());

            useEffect(() => {
                const timer = setInterval(() => setTime(new Date()), 1000);
                return () => clearInterval(timer);
            }, []);

            return (
                <div className="absolute bottom-4 left-4 bg-white/90 px-4 py-2 rounded-xl text-3xl font-mono text-gray-700 font-bold z-40 border-2 border-gray-300 shadow-md">
                    {time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                </div>
            );
        };

        const App = () => {
            const [currentSlide, setCurrentSlide] = useState(0);
            const [lightStatus, setLightStatus] = useState('red');
            const [user, setUser] = useState(null);
            const [students, setStudents] = useState(MOCK_STUDENTS);
            const [isTabletMode, setIsTabletMode] = useState(false);
            const [selectedStudentId, setSelectedStudentId] = useState(null);
            const [isOfflineMode, setIsOfflineMode] = useState(!db); 
            const [isLocalFile, setIsLocalFile] = useState(false);
            const [loadingError, setLoadingError] = useState("");
            const [connectionStatus, setConnectionStatus] = useState("connecting");
            const [revealResults, setRevealResults] = useState(false);
            const [isSubmitting, setIsSubmitting] = useState(false);
            
            // ç¹ªæœ¬é–±è®€å™¨ç‹€æ…‹
            const [showBook, setShowBook] = useState(false);
            const [bookPage, setBookPage] = useState(1);
            const TOTAL_PAGES = 19;

            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                if (params.get('mode') === 'student') setIsTabletMode(true);
                if (window.location.protocol === 'file:') {
                    setIsLocalFile(true);
                    setIsOfflineMode(true);
                    setConnectionStatus("disconnected");
                }
            }, []);

            // Auth Logic
            useEffect(() => {
                if (!db) {
                    setConnectionStatus("disconnected");
                    const savedData = localStorage.getItem('local_students_data_v2');
                    if (savedData) setStudents(JSON.parse(savedData));
                    return;
                }

                const initAuth = async () => {
                    try {
                        setLoadingError("");
                        setConnectionStatus("connecting");
                        if (TEACHER_FIREBASE_CONFIG) {
                            await auth.signInAnonymously();
                        } else {
                            await auth.signInAnonymously();
                        }
                    } catch (e) {
                        console.error("Auth error:", e);
                        setConnectionStatus("disconnected");
                        if (e.code === 'auth/operation-not-allowed') {
                            setLoadingError("è«‹å» Firebase Console é–‹å•Ÿã€ŒåŒ¿åç™»å…¥ã€");
                        } else if (e.code === 'auth/unauthorized-domain') {
                            setLoadingError("ç¶²åŸŸæœªæˆæ¬Šï¼šè«‹åˆ° Firebase æ–°å¢ github.io");
                        } else {
                            setLoadingError(`é€£ç·šå¤±æ•—: ${e.code}`);
                        }
                    }
                };
                initAuth();
                const unsubscribe = auth.onAuthStateChanged((u) => {
                    setUser(u);
                    if (u) setConnectionStatus("connected");
                    else setConnectionStatus("disconnected");
                });
                return () => unsubscribe();
            }, []);

            // Firestore Data Logic
            useEffect(() => {
                if (!user || !db) return;

                const studentsRef = db.collection('artifacts').doc(APP_ID_FIXED)
                                      .collection('public').doc('data')
                                      .collection(COLLECTION_NAME);
                
                const unsubscribe = studentsRef.onSnapshot((snapshot) => {
                    setConnectionStatus("connected");
                    const loadedStudents = [];
                    snapshot.forEach(doc => {
                        loadedStudents.push({ id: doc.id, ...doc.data() });
                    });

                    if (loadedStudents.length > 0) {
                        loadedStudents.sort((a, b) => a.order - b.order);
                        setStudents(loadedStudents);
                        setLoadingError("");
                    } else {
                        initializeStudents(studentsRef);
                    }
                }, (error) => {
                    console.error("Firestore Error:", error);
                    setConnectionStatus("disconnected");
                    setLoadingError("è³‡æ–™åº«æ–·ç·š: " + error.message);
                });

                return () => unsubscribe();
            }, [user]);

            const initializeStudents = async (collectionRef = null) => {
                if (!db) return;
                try {
                    const targetRef = collectionRef || db.collection('artifacts').doc(APP_ID_FIXED)
                                      .collection('public').doc('data')
                                      .collection(COLLECTION_NAME);
                    
                    const batch = db.batch();
                    STUDENT_DATA.forEach((s, index) => {
                        const docRef = targetRef.doc(s.id);
                        batch.set(docRef, {
                            name: s.name,
                            order: index,
                            checks: { eyes: false, hand: false, mouth: false },
                            submitted: false,
                            completed: false
                        });
                    });
                    await batch.commit();
                } catch (e) {
                    console.error("Init failed", e);
                }
            };

            const resetAllStudents = async () => {
                if (!db || !user) {
                    alert("æœªé€£ç·šï¼Œç„¡æ³•é‡ç½®");
                    return;
                }
                if (!confirm("ç¢ºå®šè¦é‡ç½®æ‰€æœ‰å­¸ç”Ÿçš„ç‹€æ…‹å—ï¼Ÿ")) return;
                
                setRevealResults(false);

                try {
                    const batch = db.batch();
                    const collectionRef = db.collection('artifacts').doc(APP_ID_FIXED)
                                          .collection('public').doc('data')
                                          .collection(COLLECTION_NAME);
                    
                    students.forEach(student => {
                        const docRef = collectionRef.doc(student.id);
                        batch.update(docRef, {
                            checks: { eyes: false, hand: false, mouth: false },
                            submitted: false
                        });
                    });
                    await batch.commit();
                } catch (e) {
                    console.error("Reset failed", e);
                    alert("é‡ç½®å¤±æ•—: " + e.message);
                }
            };

            const updateStudentCheck = async (studentId, checkItem, currentValue) => {
                const nextValue = !currentValue;
                setStudents(prev => prev.map(s => {
                    if (s.id === studentId) {
                        return { ...s, checks: { ...s.checks, [checkItem]: nextValue } };
                    }
                    return s;
                }));

                if (db && user) {
                    try {
                        const studentRef = db.collection('artifacts').doc(APP_ID_FIXED)
                                             .collection('public').doc('data')
                                             .collection(COLLECTION_NAME)
                                             .doc(studentId);
                        studentRef.update({ [`checks.${checkItem}`]: nextValue });
                    } catch (e) { console.error("Sync failed", e); }
                } else {
                    saveToLocal();
                }
            };

            const submitStudentData = async (studentId, status) => {
                if (!db || !user || connectionStatus !== "connected") {
                    alert("å°šæœªé€£ç·šåˆ°é›²ç«¯ï¼Œç„¡æ³•é€å‡ºï¼è«‹æª¢æŸ¥ç¶²è·¯æˆ–å³ä¸Šè§’ç‹€æ…‹ã€‚");
                    return;
                }

                setIsSubmitting(true);

                try {
                    const studentRef = db.collection('artifacts').doc(APP_ID_FIXED)
                                         .collection('public').doc('data')
                                         .collection(COLLECTION_NAME)
                                         .doc(studentId);
                    await studentRef.update({ submitted: status });
                    
                    setStudents(prev => prev.map(s => {
                        if (s.id === studentId) return { ...s, submitted: status };
                        return s;
                    }));
                    
                } catch (e) {
                    console.error("Sync failed", e);
                    alert("é€å‡ºå¤±æ•—ï¼š" + e.message);
                } finally {
                    setIsSubmitting(false);
                }
            };

            const saveToLocal = () => {
                localStorage.setItem('local_students_data_v2', JSON.stringify(students));
            };

            const calculateScore = (checks) => Object.values(checks || {}).filter(Boolean).length;

            const totalSlides = 9;
            const nextSlide = () => { if (currentSlide < totalSlides - 1) setCurrentSlide(currentSlide + 1); };
            const prevSlide = () => { if (currentSlide > 0) setCurrentSlide(currentSlide - 1); };

            useEffect(() => {
                const handleKeyDown = (e) => {
                    if (isTabletMode) return;
                    if (showBook) {
                         if (e.key === 'ArrowRight') setBookPage(p => Math.min(TOTAL_PAGES, p + 1));
                         if (e.key === 'ArrowLeft') setBookPage(p => Math.max(1, p - 1));
                         if (e.key === 'Escape') setShowBook(false);
                         return;
                    }
                    if (e.key === 'ArrowRight' || e.key === ' ') nextSlide();
                    if (e.key === 'ArrowLeft') prevSlide();
                };
                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, [currentSlide, isTabletMode, showBook]);

            const ConnectionStatus = () => {
                let color = "bg-gray-400";
                let text = "é€£ç·šä¸­...";
                if (connectionStatus === "connected") { color = "bg-green-500"; text = "â— é€£ç·šæ­£å¸¸"; }
                else if (connectionStatus === "disconnected") { color = "bg-red-500"; text = "â— æ–·ç·š"; }
                else if (connectionStatus === "connecting") { color = "bg-yellow-500"; text = "â— é€£ç·šä¸­..."; }

                return (
                    <div className="absolute top-4 right-4 flex items-center gap-2 z-50 bg-white/90 px-3 py-1 rounded-full shadow-md border-2 border-gray-100">
                        <span className={`text-base font-bold ${color === 'bg-green-500' ? 'text-green-600' : 'text-red-500'}`}>{text}</span>
                    </div>
                );
            };

            // ç¹ªæœ¬é–±è®€å™¨
            const BookReader = () => {
                if (!showBook) return null;
                // ä½¿ç”¨ room-XX.jpg æ ¼å¼
                const imagePath = `./image/room-${String(bookPage).padStart(2, '0')}.jpg`;

                return (
                    <div className="book-reader-overlay">
                        <button 
                            onClick={() => setShowBook(false)}
                            className="absolute top-6 right-6 text-white text-4xl font-bold bg-gray-800/50 rounded-full w-12 h-12 flex items-center justify-center hover:bg-red-600 transition-colors z-50"
                        >
                            Ã—
                        </button>
                        
                        <div className="flex items-center gap-4 w-full justify-center px-4">
                            <button 
                                onClick={(e) => { e.stopPropagation(); setBookPage(p => Math.max(1, p - 1)); }}
                                disabled={bookPage === 1}
                                className="text-white text-4xl bg-gray-800/50 rounded-full w-16 h-16 flex items-center justify-center hover:bg-white/20 disabled:opacity-30 transition-all"
                            >
                                â€¹
                            </button>
                            
                            <div className="relative flex flex-col items-center">
                                <img 
                                    src={imagePath} 
                                    alt={`Page ${bookPage}`} 
                                    className="book-image"
                                    onError={(e) => {
                                        e.target.style.display = 'none';
                                        e.target.parentNode.innerHTML = `<div class="text-white text-xl p-10 border border-white text-center">åœ–ç‰‡è®€å–å¤±æ•—<br/>è«‹ç¢ºèªæª”æ¡ˆä½ç½®: ${imagePath}<br/>(GitHub éœ€æ³¨æ„å¤§å°å¯«)</div>`;
                                    }}
                                />
                                <div className="text-white text-xl font-bold mt-2 bg-black/50 px-4 py-1 rounded-full">
                                    {bookPage} / {TOTAL_PAGES}
                                </div>
                            </div>

                            <button 
                                onClick={(e) => { e.stopPropagation(); setBookPage(p => Math.min(TOTAL_PAGES, p + 1)); }}
                                disabled={bookPage === TOTAL_PAGES}
                                className="text-white text-4xl bg-gray-800/50 rounded-full w-16 h-16 flex items-center justify-center hover:bg-white/20 disabled:opacity-30 transition-all"
                            >
                                â€º
                            </button>
                        </div>
                    </div>
                );
            };

            // --- Views ---
            if (isTabletMode) {
                if (selectedStudentId === null) {
                    return (
                        <div className="tablet-mode-container p-4">
                            <ConnectionStatus />
                            {loadingError && <div className="mt-8 text-center bg-red-100 p-2 text-red-600 font-bold rounded-xl border-2 border-red-300">{loadingError}</div>}
                            
                            <h1 className="text-5xl font-black text-pink-800 text-center mb-6 mt-4">æˆ‘æ˜¯èª°ï¼Ÿ</h1>
                            
                            <div className="grid grid-cols-2 gap-4 max-w-4xl mx-auto">
                                {students.map(student => (
                                    <button
                                        key={student.id}
                                        onClick={() => {
                                            if(connectionStatus !== 'connected') alert("è«‹ç­‰å¾…é€£ç·šæˆåŠŸ (ç¶ ç‡ˆ)...");
                                            else setSelectedStudentId(student.id);
                                        }}
                                        className={`p-6 rounded-2xl shadow-md border-b-8 active:translate-y-1 active:border-b-0 transition-all ${student.submitted ? 'bg-green-100 border-green-400' : 'bg-white border-pink-300'}`}
                                    >
                                        <div className="text-3xl font-bold text-gray-800">{student.name}</div>
                                        {student.submitted && <div className="mt-2 text-xl font-bold text-green-700">å·²é€å‡º âœ…</div>}
                                    </button>
                                ))}
                            </div>
                        </div>
                    );
                } else {
                    const currentStudent = students.find(s => s.id === selectedStudentId);
                    if (!currentStudent) return <div>è¼‰å…¥ä¸­...</div>;
                    const isSubmitted = currentStudent.submitted;

                    return (
                        <div className="tablet-mode-container flex flex-col items-center">
                            <ConnectionStatus />
                            <div className="w-full max-w-3xl flex justify-between items-center mb-4 mt-4">
                                <h2 className="text-4xl font-black text-pink-800">{currentStudent.name}</h2>
                                <button onClick={() => setSelectedStudentId(null)} className="bg-gray-200 text-gray-700 px-6 py-2 rounded-full font-bold text-xl shadow-md">è¿”å›</button>
                            </div>
                            
                            <div className="flex-1 w-full max-w-3xl space-y-3 relative">
                                {isSubmitted && (
                                    <div className="absolute inset-0 bg-white/95 z-10 rounded-3xl flex flex-col items-center justify-center backdrop-blur-sm border-4 border-green-200">
                                        <div className="text-6xl mb-4">âœ…</div>
                                        <div className="text-4xl font-bold text-green-700 mb-6">ç­”æ¡ˆå·²é€å‡ºï¼</div>
                                        <button 
                                            onClick={() => submitStudentData(currentStudent.id, false)}
                                            className="bg-gray-500 text-white px-8 py-3 rounded-full font-bold text-2xl shadow-lg hover:bg-gray-600"
                                            disabled={isSubmitting}
                                        >
                                            {isSubmitting ? 'è™•ç†ä¸­...' : 'ä¿®æ”¹ç­”æ¡ˆ'}
                                        </button>
                                    </div>
                                )}

                                {[{ key: 'eyes', icon: 'ğŸ‘€', text: 'æˆ‘æœ‰çœ‹ç´…ç¶ ç‡ˆ' }, { key: 'hand', icon: 'âœ‹', text: 'æˆ‘æƒ³èªªè©±æœ‰èˆ‰æ‰‹' }, { key: 'mouth', icon: 'ğŸ¤', text: 'åˆ¥äººèªªè©±æˆ‘å®‰éœ' }].map(item => (
                                    <div key={item.key} onClick={() => !isSubmitted && updateStudentCheck(currentStudent.id, item.key, currentStudent.checks[item.key])} className={`flex items-center p-5 bg-white rounded-2xl shadow-md cursor-pointer transition-all border-l-[12px] active:scale-95 ${currentStudent.checks[item.key] ? 'border-green-500 bg-green-50' : 'border-gray-300'}`}>
                                        <div className={`w-14 h-14 rounded-xl border-4 mr-4 flex items-center justify-center transition-colors flex-shrink-0 ${currentStudent.checks[item.key] ? 'bg-green-500 border-green-500' : 'border-gray-300'}`}>{currentStudent.checks[item.key] && <span className="text-3xl text-white font-bold">âœ“</span>}</div>
                                        <span className="text-4xl mr-4">{item.icon}</span><span className="text-3xl font-bold text-gray-700">{item.text}</span>
                                    </div>
                                ))}
                            </div>
                            
                            {!isSubmitted && (
                                <div className="mt-6 mb-8 w-full max-w-3xl">
                                    <button 
                                        onClick={() => submitStudentData(currentStudent.id, true)}
                                        disabled={isSubmitting}
                                        className={`w-full text-white text-4xl font-black py-4 rounded-3xl shadow-xl border-b-8 active:translate-y-2 active:border-b-0 transition-all flex items-center justify-center gap-4 ${isSubmitting ? 'bg-gray-400 border-gray-600 cursor-wait' : 'bg-pink-500 hover:bg-pink-600 border-pink-700'}`}
                                    >
                                        {isSubmitting ? 'å‚³é€ä¸­...' : <span>ğŸš€ ç¢ºèªé€å‡º</span>}
                                    </button>
                                </div>
                            )}
                        </div>
                    );
                }
            }

            const SlideContent = () => {
                switch(currentSlide) {
                    case 0: return (
                        <div className="content-area bg-blue-50">
                            <div className="text-8xl animate-bounce-slow mb-4">ğŸ¦</div>
                            <h1 className="text-6xl font-black text-blue-800 tracking-wider mb-4">ç¤¾æœƒæŠ€å·§èª²</h1>
                            <div className="bg-white px-8 py-3 rounded-2xl border-4 border-blue-300 shadow-xl mb-4"><h2 className="text-3xl font-bold text-gray-700">æµ£ç†Šçš„æˆ¿é–“èˆ‡èªªè©±è¦å‰‡</h2></div>
                            <p className="text-xl text-gray-500 font-bold">æº–å‚™å¥½ä½ çš„è€³æœµå’Œçœ¼ç›äº†å—ï¼Ÿ</p>
                        </div>
                    );
                    case 1: return (
                        <div className="content-area bg-yellow-50">
                            <h2 className="text-5xl font-bold text-yellow-800 border-b-4 border-yellow-200 pb-2 mb-6">ä»Šå¤©çš„ä»»å‹™</h2>
                            <div className="flex-1 flex flex-col justify-center gap-6 w-full max-w-3xl">
                                <div className="flex items-center p-4 bg-white rounded-2xl shadow-lg border-l-[12px] border-blue-500 hover:scale-105 transition-transform"><span className="text-5xl mr-6">ğŸ“–</span><span className="text-3xl font-bold text-gray-700">1. è½ç¹ªæœ¬æ•…äº‹</span></div>
                                <div className="flex items-center p-4 bg-white rounded-2xl shadow-lg border-l-[12px] border-green-500 hover:scale-105 transition-transform"><span className="text-5xl mr-6">ğŸ²</span><span className="text-3xl font-bold text-gray-700">2. éµå®ˆéŠæˆ²è¦å‰‡</span></div>
                                <div className="flex items-center p-4 bg-white rounded-2xl shadow-lg border-l-[12px] border-red-500 hover:scale-105 transition-transform"><span className="text-5xl mr-6">â­</span><span className="text-3xl font-bold text-gray-700">3. è“‹å°ç« </span></div>
                            </div>
                        </div>
                    );
                    case 2: return (
                        <div className="content-area bg-white">
                            <h2 className="text-5xl font-bold text-center text-gray-800 mb-6">æ•™å®¤è£¡çš„ç´…ç¶ ç‡ˆ</h2>
                            <div className="flex justify-around items-center w-full flex-1 gap-4">
                                <div className={`flex flex-col items-center p-6 rounded-3xl transition-all duration-300 cursor-pointer ${lightStatus === 'red' ? 'bg-red-50 scale-105 border-8 border-red-400 shadow-xl' : 'opacity-40 grayscale hover:opacity-70'}`} onClick={() => setLightStatus('red')}>
                                    <div className="w-32 h-32 rounded-full bg-red-500 shadow-xl flex items-center justify-center mb-4 border-8 border-white ring-4 ring-red-200"><span className="text-6xl">ğŸ‘‚</span></div>
                                    <h3 className="text-3xl font-black text-red-600 mb-2">ç´…ç‡ˆ</h3><p className="text-xl font-bold text-gray-600">è€³æœµæ‰“é–‹<br/>å˜´å·´æ‹‰æ‹‰éŠ</p>
                                </div>
                                <div className={`flex flex-col items-center p-6 rounded-3xl transition-all duration-300 cursor-pointer ${lightStatus === 'green' ? 'bg-green-50 scale-105 border-8 border-green-400 shadow-xl' : 'opacity-40 grayscale hover:opacity-70'}`} onClick={() => setLightStatus('green')}>
                                    <div className="w-32 h-32 rounded-full bg-green-500 shadow-xl flex items-center justify-center mb-4 border-8 border-white ring-4 ring-green-200"><span className="text-6xl">ğŸ—£ï¸</span></div>
                                    <h3 className="text-3xl font-black text-green-600 mb-2">ç¶ ç‡ˆ</h3><p className="text-xl font-bold text-gray-600">ç¾åœ¨è¼ªåˆ°ä½ <br/>å¯ä»¥èªªè©±</p>
                                </div>
                            </div>
                        </div>
                    );
                    case 3: return (
                        <div className="content-area bg-indigo-50">
                            <h2 className="text-5xl font-bold text-indigo-900 mb-4">ç¾åœ¨æ˜¯ä»€éº¼ç‡ˆï¼Ÿ</h2>
                            <div className="flex items-center justify-center gap-8 w-full flex-1">
                                <div 
                                    className="bg-white p-4 rounded-3xl shadow-xl border-4 border-indigo-200 transform -rotate-2 cursor-pointer hover:scale-105 transition-transform"
                                    onClick={() => { setBookPage(1); setShowBook(true); }}
                                    title="é»æ“Šé–±è®€ç¹ªæœ¬"
                                >
                                    <div className="relative">
                                        <img src="./image/room-01.jpg" alt="æµ£ç†Šçš„æˆ¿é–“" className="w-[18rem] h-[24rem] object-cover rounded-2xl mb-2 shadow-inner bg-gray-100" onError={(e) => { e.target.style.display = 'none'; e.target.nextSibling.style.display = 'flex'; }} />
                                        <div className="w-[18rem] h-[24rem] bg-gray-200 hidden flex-col items-center justify-center rounded-2xl mb-2 text-gray-400 text-center p-4"><div className="text-center"><div className="text-5xl mb-2">ğŸ“š</div><div className="text-lg font-bold">åœ–ç‰‡è®€å–å¤±æ•—<br/>room-01.jpg</div></div></div>
                                        
                                        <div className="absolute bottom-2 right-2 bg-yellow-400 text-white rounded-full p-2 shadow-lg animate-bounce">
                                            <span className="text-2xl">ğŸ‘†</span>
                                        </div>
                                    </div>
                                    <p className="text-2xl text-center font-bold text-gray-700">è€å¸«åœ¨è¬›æ•…äº‹</p>
                                </div>
                                <div className="text-6xl font-bold text-indigo-300 animate-pulse">â¡ï¸</div>
                                <div className="flex flex-col items-center animate-bounce-slow">
                                    <div className="w-32 h-32 rounded-full bg-red-500 shadow-2xl flex items-center justify-center border-8 border-white ring-4 ring-red-200"><span className="text-6xl">ğŸ¤«</span></div>
                                    <p className="text-3xl font-bold text-red-600 mt-4 bg-white px-6 py-2 rounded-full shadow-lg border-4 border-red-100">ç¾åœ¨æ˜¯ç´…ç‡ˆ</p>
                                </div>
                            </div>
                        </div>
                    );
                    case 4: return (
                        <div className="content-area bg-orange-50">
                            <h2 className="text-6xl font-bold text-orange-800 mb-8 text-center">æˆ‘å¥½æƒ³èªªè©±ï¼Œæ€éº¼è¾¦ï¼Ÿ</h2>
                            <div className="flex-1 flex flex-col justify-center items-center gap-10 w-full">
                                <div className="bg-white px-16 py-8 rounded-[3rem] shadow-xl border-8 border-orange-300 flex flex-col items-center cursor-pointer hover:scale-105 transition-transform">
                                    <span className="text-[6rem] mb-2 leading-none">âœ‹</span><h3 className="text-5xl font-black text-orange-600">ç­‰å¾…å¡</h3>
                                </div>
                                <div className="w-full max-w-4xl space-y-6">
                                    <div className="flex items-center text-4xl font-bold text-gray-700 bg-white/60 p-6 rounded-3xl"><span className="bg-orange-500 text-white w-14 h-14 text-3xl rounded-full flex items-center justify-center mr-6 shadow-md font-black flex-shrink-0">1</span>æŠŠã€Œç­‰å¾…å¡ã€èˆ‰é«˜</div>
                                    <div className="flex items-center text-4xl font-bold text-gray-700 bg-white/60 p-6 rounded-3xl"><span className="bg-orange-500 text-white w-14 h-14 text-3xl rounded-full flex items-center justify-center mr-6 shadow-md font-black flex-shrink-0">2</span>è«‹å®‰éœï¼Œçœ¼ç›çœ‹è€å¸«</div>
                                    <div className="flex items-center text-4xl font-bold text-gray-700 bg-white/60 p-6 rounded-3xl"><span className="bg-orange-500 text-white w-14 h-14 text-3xl rounded-full flex items-center justify-center mr-6 shadow-md font-black flex-shrink-0">3</span>è€å¸«é»é ­ï¼Œè®Šç¶ ç‡ˆå†èªªè©±</div>
                                </div>
                            </div>
                        </div>
                    );
                    case 5: return (
                        <div className="content-area bg-white">
                            <h2 className="text-5xl font-bold text-center text-purple-800 mb-6">å¹«å¹«å°å…”å­ï¼</h2>
                            <div className="flex-1 flex items-center justify-center space-x-8 w-full">
                                <div className="relative group">
                                    <span className="text-[8rem] block transform group-hover:-translate-y-4 transition-transform duration-300">ğŸ°</span>
                                    <div className="absolute -top-12 -right-20 bg-white border-4 border-gray-800 rounded-2xl p-3 shadow-xl w-48 z-10 bubble-bottom-left"><p className="text-lg font-bold leading-relaxed">æˆ‘å‘Šè¨´ä½ å–”ï¼é‚£å€‹æµ£ç†Šå¾Œä¾†å°±...</p></div>
                                    <p className="text-center text-xl font-bold mt-2 bg-purple-100 py-2 px-6 rounded-full text-purple-800">é˜¿ç™½ (ä¸€ç›´èªª)</p>
                                </div>
                                <div className="relative opacity-60">
                                    <span className="text-[8rem] block transform scale-x-[-1]">ğŸ°</span>
                                    <div className="absolute -top-6 -left-10 animate-pulse"><span className="text-4xl">ğŸ˜–</span></div>
                                    <p className="text-center text-xl font-bold mt-2 bg-gray-200 py-2 px-6 rounded-full text-gray-600">åœŸåœŸ (æƒ³å®‰éœ)</p>
                                </div>
                            </div>
                            <div className="bg-purple-100 p-4 rounded-3xl text-center mt-6 max-w-2xl mx-auto border-4 border-purple-200 mb-4">
                                <p className="text-2xl font-bold text-purple-900 mb-2">é˜¿ç™½å¿˜è¨˜çœ‹ç´…ç¶ ç‡ˆäº†ï¼</p><p className="text-xl text-purple-700 font-bold">èª°å¯ä»¥æ‹¿ã€Œç­‰å¾…å¡ã€æ•™æ•™ä»–ï¼Ÿ</p>
                            </div>
                        </div>
                    );
                    case 6: return (
                        <div className="content-area bg-cyan-50">
                            <h2 className="text-5xl font-bold text-cyan-800 mb-6">é€™æ˜¯èª°çš„ç™¼è¨€æ™‚é–“ï¼Ÿ</h2>
                            <div className="flex-1 flex flex-col justify-center items-center w-full">
                                <div className="bg-gradient-to-br from-gray-700 to-gray-900 p-6 rounded-full shadow-2xl mb-6 border-8 border-gray-300 transform hover:scale-110 transition-transform duration-500"><span className="text-[6rem] text-white">ğŸ¤</span></div>
                                <div className="bg-white p-6 rounded-3xl shadow-xl border-l-[16px] border-cyan-500 max-w-3xl w-full">
                                    <div className="grid grid-cols-2 gap-6 text-center">
                                        <div className="p-4 bg-green-50 rounded-2xl"><p className="text-xl text-gray-500 mb-2">æœ‰æ‹¿ <span className="text-cyan-600 font-bold">éº¥å…‹é¢¨</span></p><p className="text-3xl font-black text-green-600">= ç¶ ç‡ˆ ğŸŸ¢</p></div>
                                        <div className="p-4 bg-red-50 rounded-2xl"><p className="text-xl text-gray-500 mb-2">æ²’æœ‰æ‹¿çš„äºº</p><p className="text-3xl font-black text-red-600">= ç´…ç‡ˆ ğŸ”´</p></div>
                                    </div>
                                </div>
                                <p className="mt-6 text-2xl text-gray-600 font-bold bg-white/80 px-6 py-2 rounded-full border-4 border-cyan-200 shadow-lg">å¦‚æœä½ æƒ³æ‹¿éº¥å…‹é¢¨ï¼Œè¦å…ˆåšä»€éº¼ï¼Ÿ</p>
                            </div>
                        </div>
                    );
                    case 7: 
                        const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(window.location.href + '?mode=student')}`;
                        return (
                            <div className="content-area bg-pink-50 relative px-4 py-2">
                                <div className="absolute top-4 left-4 flex gap-4">
                                    <ConnectionStatus />
                                    <button 
                                        onClick={() => window.location.reload()} 
                                        className="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-xl shadow-lg font-bold text-lg flex items-center gap-2"
                                    >
                                        <span>ğŸ”„</span> é‡æ•´
                                    </button>
                                </div>
                                
                                <div className="flex justify-center items-center mb-4 relative w-full">
                                    <h2 className="text-5xl font-bold text-pink-800 text-center">å…¨ç­æŒ‘æˆ°è³½</h2>
                                    <div className="absolute right-0 top-0 flex gap-4">
                                        <button 
                                            onClick={() => setRevealResults(!revealResults)} 
                                            className={`px-6 py-3 rounded-xl text-2xl font-bold shadow-lg transition-all transform hover:scale-105 border-4 ${revealResults ? 'bg-gray-500 border-gray-600 text-white' : 'bg-yellow-400 border-yellow-200 text-yellow-900 animate-pulse'}`}
                                        >
                                            {revealResults ? 'ğŸ™ˆ éš±è—' : 'ğŸ‘€ æ­æ›‰'}
                                        </button>
                                        <button onClick={resetAllStudents} className="bg-gray-200 text-gray-600 hover:bg-red-100 hover:text-red-500 px-6 py-3 rounded-xl text-2xl font-bold shadow-md">é‡ç½®</button>
                                    </div>
                                </div>

                                {isOfflineMode && <div className="absolute top-4 left-4 text-red-500 text-xl font-bold bg-white p-3 rounded-xl shadow-lg border-2 border-red-200 z-50">âš ï¸ æœªè¨­å®š Firebase</div>}
                                {loadingError && (
                                    <div className="absolute top-20 left-6 flex gap-2 z-50">
                                        <div className="text-red-600 font-bold bg-white p-3 rounded-xl border-2 border-red-300 shadow-xl text-lg whitespace-pre-wrap max-w-md">{loadingError}</div>
                                    </div>
                                )}
                                
                                {students.length === 0 && !loadingError && (
                                    <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-center">
                                        <p className="text-gray-500 text-2xl font-bold mb-6">è³‡æ–™åº«ç›®å‰æ˜¯ç©ºçš„</p>
                                        <button onClick={() => initializeStudents()} className="bg-pink-500 text-white px-8 py-4 rounded-full shadow-xl font-bold text-2xl hover:bg-pink-600 transition-colors">
                                            é»æˆ‘åˆå§‹åŒ–å­¸ç”Ÿåå–®
                                        </button>
                                    </div>
                                )}

                                <div className="flex-1 w-full grid grid-cols-4 gap-4 align-content-start overflow-y-auto pb-20 px-2">
                                    {students.map(student => {
                                        const score = calculateScore(student.checks);
                                        const isDone = score === 3;
                                        return (
                                            <div key={student.id} className="flip-card h-48">
                                                <div className={`flip-card-inner ${revealResults && student.submitted ? 'flipped' : ''}`}>
                                                    {/* æ­£é¢ï¼šæœªæ­æ›‰ */}
                                                    <div className={`flip-card-front p-4 shadow-lg border-b-8 ${student.submitted ? 'bg-green-100 border-green-400' : 'bg-white border-pink-200'}`}>
                                                        {!student.submitted ? (
                                                            <>
                                                                <div className="text-5xl mb-2 animate-pulse grayscale opacity-50">ğŸ¤”</div>
                                                                <h3 className="text-3xl font-bold text-gray-500 mb-1">{student.name}</h3>
                                                                <div className="text-xl font-bold text-gray-400">ä½œç­”ä¸­...</div>
                                                            </>
                                                        ) : (
                                                            <>
                                                                <div className="text-6xl mb-2 text-green-500">âœ…</div>
                                                                <h3 className="text-3xl font-bold text-gray-800 mb-1">{student.name}</h3>
                                                                <div className="text-xl font-bold text-green-700">å·²å®Œæˆï¼</div>
                                                            </>
                                                        )}
                                                    </div>

                                                    {/* èƒŒé¢ï¼šæ­æ›‰ - é¡¯ç¤ºå®Œæˆåº¦ç´°ç¯€ */}
                                                    <div className={`flip-card-back p-4 shadow-lg border-b-8 ${isDone ? 'bg-yellow-100 border-yellow-400' : 'bg-white border-pink-200'}`}>
                                                        <div className="flex justify-between items-center w-full px-2 mb-1">
                                                            <h3 className="text-2xl font-bold text-gray-800">{student.name}</h3>
                                                            <div className={`text-3xl font-black ${isDone ? 'text-yellow-600' : 'text-pink-600'}`}>{score}/3</div>
                                                        </div>
                                                        
                                                        {/* å®Œæˆåº¦ç´°ç¯€ç‡ˆè™Ÿ - åŠ å¤§åŠ ç²— */}
                                                        <div className="flex gap-3 mb-2 w-full justify-center">
                                                            <div className={`w-12 h-12 rounded-full flex items-center justify-center text-2xl border-4 shadow-sm ${student.checks.eyes ? 'bg-green-500 border-green-600 text-white' : 'bg-gray-200 border-gray-300 text-gray-400 grayscale'}`}>ğŸ‘€</div>
                                                            <div className={`w-12 h-12 rounded-full flex items-center justify-center text-2xl border-4 shadow-sm ${student.checks.hand ? 'bg-green-500 border-green-600 text-white' : 'bg-gray-200 border-gray-300 text-gray-400 grayscale'}`}>âœ‹</div>
                                                            <div className={`w-12 h-12 rounded-full flex items-center justify-center text-2xl border-4 shadow-sm ${student.checks.mouth ? 'bg-green-500 border-green-600 text-white' : 'bg-gray-200 border-gray-300 text-gray-400 grayscale'}`}>ğŸ¤</div>
                                                        </div>

                                                        <div className="w-full bg-gray-200 rounded-full h-3 dark:bg-gray-200 px-0.5">
                                                            <div className={`h-3 rounded-full transition-all duration-500 ${isDone ? 'bg-yellow-500' : 'bg-pink-500'}`} style={{width: `${(score/3)*100}%`}}></div>
                                                        </div>
                                                        {isDone && <div className="text-red-500 font-bold text-lg mt-1">å¤ªæ£’äº†!</div>}
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>

                                {isLocalFile ? (
                                    <div className="absolute bottom-4 right-4 bg-white p-4 rounded-xl shadow-lg border-4 border-red-200 flex flex-col items-center max-w-sm">
                                        <p className="font-bold text-red-600 text-lg mb-1">âš ï¸ ç„¡æ³•æƒæ</p>
                                        <p className="text-base text-gray-600 text-center">æœ¬æ©Ÿæª”æ¡ˆ (file://) ç„¡æ³•é€£ç·š</p>
                                    </div>
                                ) : (
                                    <div className="absolute bottom-4 right-4 bg-white p-4 rounded-2xl shadow-xl flex items-center gap-4 border-4 border-pink-200">
                                        <img src={qrCodeUrl} alt="Scan" className="w-20 h-20" />
                                        <div className="text-left"><p className="font-bold text-gray-700 text-xl">æƒæåŠ å…¥</p><p className="text-base text-gray-500">å¹³æ¿æ¨¡å¼</p></div>
                                    </div>
                                )}
                            </div>
                        );
                    case 8: return (
                        <div className="content-area bg-yellow-100">
                            <div className="text-[10rem] animate-pulse drop-shadow-2xl">ğŸŒŸ</div>
                            <h2 className="text-7xl font-black text-yellow-600 tracking-wider mb-8">ä»»å‹™æˆåŠŸï¼</h2>
                            <p className="text-4xl font-bold text-gray-700 bg-white/60 px-12 py-4 rounded-full mb-8">ä½ å¯ä»¥å»è“‹å°ç« äº†ï¼</p>
                            <div className="flex gap-8 mt-4">
                                <span className="text-8xl animate-bounce" style={{animationDelay: '0s'}}>ğŸ¦</span>
                                <span className="text-8xl animate-bounce" style={{animationDelay: '0.2s'}}>ğŸ°</span>
                                <span className="text-8xl animate-bounce" style={{animationDelay: '0.4s'}}>ğŸ¦Š</span>
                            </div>
                        </div>
                    );
                    default: return <div>Slide Error</div>;
                }
            };

            return (
                <div className="slide-wrapper">
                    <div className="slide-container">
                        {/* ç¹ªæœ¬é–±è®€å™¨è¦†è“‹å±¤ */}
                        <BookReader />
                        <SlideContent />
                        {!isTabletMode && (
                            <>
                                <Clock />
                                <button onClick={prevSlide} disabled={currentSlide === 0} className="absolute left-4 top-1/2 transform -translate-y-1/2 bg-white/50 hover:bg-white text-gray-800 p-4 rounded-full shadow-lg disabled:opacity-0 transition-all backdrop-blur-sm z-10"><svg xmlns="http://www.w3.org/2000/svg" className="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M15 19l-7-7 7-7" /></svg></button>
                                <button onClick={nextSlide} disabled={currentSlide === totalSlides - 1} className="absolute right-4 top-1/2 transform -translate-y-1/2 bg-white/50 hover:bg-white text-gray-800 p-4 rounded-full shadow-lg disabled:opacity-0 transition-all backdrop-blur-sm z-10"><svg xmlns="http://www.w3.org/2000/svg" className="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M9 5l7 7-7 7" /></svg></button>
                                <div className="absolute bottom-4 right-20 bg-black/10 px-4 py-1 rounded-full text-gray-600 font-bold text-xl backdrop-blur-sm">{currentSlide + 1} / {totalSlides}</div>
                            </>
                        )}
                        {!isTabletMode && currentSlide === 7 && isLocalFile && (
                            <button onClick={() => window.open(window.location.href + '?mode=student', '_blank')} className="absolute bottom-4 left-4 bg-pink-600 text-white font-bold p-2 rounded-lg shadow-lg hover:bg-pink-700 z-50 text-sm">é–‹å•Ÿå­¸ç”Ÿå¹³æ¿è¦–çª— (æ¸¬è©¦ç”¨)</button>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
